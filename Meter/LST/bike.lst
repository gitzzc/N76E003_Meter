C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 1   


C51 COMPILER V9.50a, COMPILATION OF MODULE BIKE
OBJECT MODULE PLACED IN .\Output\bike.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Code\bike.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Include) DEFINE(FOS
                    -C_160000) DEBUG OBJECTEXTEND PRINT(.\LST\bike.lst) OBJECT(.\Output\bike.obj)

line level    source

   1          /**
   2            ******************************************************************************
   3            * @file    bike.c
   4            * @author  
   5            * @version V2.2.0
   6            * @date    30-September-2014
   7            * @brief   Main Interrupt Service Routines.
   8            *          This file provides template for all peripherals interrupt service 
   9            *          routine.
  10             ******************************************************************************
  11            * @attention
  12            *
  13            *
  14            ******************************************************************************
  15            */ 
  16            
  17          /* Includes ------------------------------------------------------------------*/
  18          #include "N76E003.h"
  19          #include "SFR_Macro.h"
  20          #include "Function_define.h"
  21          #include "Common.h"
  22          #include "Delay.h"
  23          
  24          #include "adc.h"
  25          #include "flash.h"
  26          
  27          #include "bl55072.h"
  28          #include "display.h"
  29          #include "bike.h"
  30          #include "YXT.h"
  31          
  32          
  33          /* Private typedef -----------------------------------------------------------*/
  34          /* Private define ------------------------------------------------------------*/
  35          /* Private macro -------------------------------------------------------------*/
  36          /* Private variables ---------------------------------------------------------*/
  37          #ifdef JINPENG_4860
              const uint16_t code uiBatStatus48[8] = {420,426,432,439,445,451,457,464};
              const uint16_t code uiBatStatus60[8] = {520,528,536,542,550,558,566,574};
              const uint16_t code uiBatStatus72[8] = {0};
              #elif defined JINPENG_6072
              const uint16_t code uiBatStatus48[8] = {0};
              const uint16_t code uiBatStatus60[8] = {480,493,506,519,532,545,558,570};
              const uint16_t code uiBatStatus72[8] = {550,569,589,608,628,647,667,686};
              #elif defined LCD6040
              const uint16_t code uiBatStatus48[] = {425,432,444,456,468};
              const uint16_t code uiBatStatus60[] = {525,537,553,566,578};
              const uint16_t code uiBatStatus72[] = {630,641,661,681,701};
              #else
  50          const uint16_t code uiBatStatus48[8] = {420,427,435,444,453,462,471,481};
  51          const uint16_t code uiBatStatus60[8] = {520,531,544,556,568,577,587,595};
  52          const uint16_t code uiBatStatus72[8] = {630,642,653,664,675,687,700,715};
  53          #endif
  54          
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 2   

  55          BIKE_STATUS xdata sBike;
  56          BIKE_CONFIG xdata sConfig;
  57          volatile uint16_t  uiSysTick = 0;
  58          uint16_t xdata uiSpeedBuf[16];
  59          uint16_t xdata uiVolBuf[28];
  60          uint16_t xdata uiTempBuf[4];
  61          
  62          #if ( TIME_ENABLE == 1 )
              uint8_t xdataucUart1Buf[16];
              uint8_t xdata ucUart1Index=0;
              #endif
  66          /* Private function prototypes -----------------------------------------------*/
  67          /* Private functions ---------------------------------------------------------*/
  68          /* Public functions ----------------------------------------------------------*/
  69          uint8_t GPIO_Read(uint8_t port, uint8_t pin);
  70          void GetSysVoltage(void);
  71          
  72          /*----------------------------------------------------------*/
  73          
  74          int GetTemp(void)
  75          {
  76   1              static uint8_t ucIndex = 0;
  77   1              int32_t slTemp;
  78   1              uint8_t i;
  79   1      
  80   1              uiTempBuf[ucIndex++] = uiADC_SampleBuf[0][0];
  81   1              if ( ucIndex >= ContainOf(uiTempBuf) )
  82   1                      ucIndex = 0;
  83   1              for(i=0,slTemp=0;i<ContainOf(uiTempBuf);i++)
  84   1                      slTemp += uiTempBuf[i];
  85   1              slTemp /= ContainOf(uiTempBuf);
  86   1      
  87   1              //slTemp = 470UL*1024/(1024-slTemp)-470;
  88   1              //slTemp = NTCtoTemp(slTemp)/10;
  89   1              //slTemp = ((3600- (long)slTemp * 2905/1024)/10);
  90   1      
  91   1              slTemp = 10000*1024UL/(1024-slTemp)-10000;
  92   1              slTemp = NTCtoTemp(slTemp);
  93   1              if ( slTemp > 999  ) slTemp =  999;
  94   1              if ( slTemp < -999 ) slTemp = -999;
  95   1              
  96   1              return slTemp;
  97   1      }
  98          #if 0
              uint16_t GetVol(void)
              {
                      static uint8_t ucIndex = 0;
                      uint16_t uiVol;
                      uint8_t i;
              
                      uiVolBuf[ucIndex++] = uiADC_SampleBuf[0][0];
                      if ( ucIndex >= ContainOf(uiVolBuf) )
                              ucIndex = 0;
                      for(i=0,uiVol=0;i<ContainOf(uiVolBuf);i++)
                              uiVol += uiVolBuf[i];
                      uiVol /= ContainOf(uiVolBuf);
                      uiVol = (uint32_t)uiVol*1050/1024 ;
                      
                      return uiVol;
              }
              #else
 116          uint8_t GetVolStabed(uint16_t* uiVol)
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 3   

 117          {
 118   1              uint32_t ulMid;
 119   1              uint16_t uiBuf[32];
 120   1              uint8_t i;
 121   1              
 122   1              *uiVol = (uint32_t)uiADC_SampleBuf[0][0]*1050UL/1024UL;
 123   1      
 124   1              for(i=0,ulMid=0;i<32;i++)       ulMid += uiBuf[i];
 125   1              ulMid /= 32;
 126   1              for( i=0;i<32;i++){
 127   2                      if ( ulMid > 5 && ((ulMid *100 / uiBuf[i]) > 101 ||  (ulMid *100 / uiBuf[i]) < 99) )
 128   2                              return 0;
 129   2              }
 130   1              
 131   1              return 1;
 132   1      }
 133          
 134          #endif
 135          
 136          #if ( PCB_VER == 0013 )
              uint8_t GetSpeedAdj(void)
              {
                      static uint8_t ucIndex = 0;
                      uint16_t uiAdj;
                      uint8_t i;
              
                      uiSpeedBuf[ucIndex++] = uiADC_SampleBuf[0][0];
                      if ( ucIndex >= ContainOf(uiSpeedBuf) )
                              ucIndex = 0;
              
                      for(i=0,uiAdj=0;i<ContainOf(uiSpeedBuf);i++)
                              uiAdj += uiSpeedBuf[i];
                      uiAdj /= ContainOf(uiSpeedBuf);
                      
                      if ( uiAdj > 99 )
                              uiAdj = 99;
                      
                return uiAdj;
              }
              #endif
 157          
 158          uint8_t GetSpeed(void)
 159          {
 160   1              static uint8_t ucIndex = 0;
 161   1              uint16_t uiSpeed;
 162   1              uint8_t i;
 163   1      
 164   1              uiSpeedBuf[ucIndex++] = uiADC_SampleBuf[0][0];
 165   1              if ( ucIndex >= ContainOf(uiSpeedBuf) )
 166   1                      ucIndex = 0;
 167   1      
 168   1              for(i=0,uiSpeed=0;i<ContainOf(uiSpeedBuf);i++)
 169   1                      uiSpeed += uiSpeedBuf[i];
 170   1              uiSpeed /= ContainOf(uiSpeedBuf);
 171   1              
 172   1              if ( sConfig.uiSysVoltage               == 48 ){
 173   2                      uiSpeed = SPEED_CALC_48V((uint32_t)uiSpeed);
 174   2              } else if ( sConfig.uiSysVoltage== 60 ) {
 175   2                      uiSpeed = SPEED_CALC_60V((uint32_t)uiSpeed);
 176   2              } else if ( sConfig.uiSysVoltage== 72 ) {
 177   2                      uiSpeed = SPEED_CALC_72V((uint32_t)uiSpeed);
 178   2              }
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 4   

 179   1              if ( uiSpeed > 99 )
 180   1                      uiSpeed = 99;
 181   1              
 182   1        return uiSpeed;
 183   1      }
 184          
 185          
 186          void GetSysVoltage(void)
 187          {       
 188   1              
 189   1      #if defined BENLING_OUSHANG
                      uint16_t uiVol;
                      for(i=0;i<0xFF;i++){
                              if ( GetVolStabed(&uiVol) && (uiVol > 120) ) break;
                              FEED_DOG();  
                      }
                      if ( 720 <= uiVol && uiVol <= 870 ){
                              sConfig.uiSysVoltage = 72;
                              WriteConfig();
                      } else if ( 480 <= uiVol && uiVol <= 600 ){
                              sConfig.uiSysVoltage = 60;
                              WriteConfig();
                      }
              #elif defined VD61723650
                      uint16_t uiVol;
                      for(i=0;i<0xFF;i++){
                              if ( GetVolStabed(&uiVol) && (uiVol > 120) ) break;
                              FEED_DOG();  
                      }
                      if ( 610 <= uiVol && uiVol <= 720 ){
                              sConfig.uiSysVoltage = 60;
                              WriteConfig();
                      }       else if ( 360 <= uiVol && uiVol <= 500 ){
                              sConfig.uiSysVoltage = 48;
                              WriteConfig();
                      }               
              #elif defined VD48
                      sConfig.uiSysVoltage = 48;
              #elif defined VD60
                      sConfig.uiSysVoltage = 60;
              #elif defined VD72
                      sConfig.uiSysVoltage = 72;
              #elif defined VD48N72L
                      if ( GPIO_Read(V48_PORT, V48_PIN) == RESET ){
                              sConfig.uiSysVoltage = 72;
                      } else {
                              sConfig.uiSysVoltage = 60;
                      }
              #elif defined VD48L72N
                      if ( GPIO_Read(V48_PORT, V48_PIN) == RESET ){
                              sConfig.uiSysVoltage = 48;
                      } else {
                              sConfig.uiSysVoltage = 60;
                      }
              #elif defined VD48H72N
                      if ( GPIO_Read(V48_PORT, V48_PIN) == RESET ){
                              sConfig.uiSysVoltage = 60;
                      } else {
                              sConfig.uiSysVoltage = 48;
                      }
              #elif defined VD72L48L
 240   1              if ( GPIO_Read(V72_PORT, V72_PIN) == RESET ){
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 5   

 241   2                      sConfig.uiSysVoltage = 72;
 242   2              } else {
 243   2                      if ( GPIO_Read(V48_PORT, V48_PIN) == RESET ){
 244   3                              sConfig.uiSysVoltage = 48;
 245   3                      } else {
 246   3                              sConfig.uiSysVoltage = 60;
 247   3                      }
 248   2              }
 249   1      #else
                      #error "Please select a system voltage detection method!!!"
              #endif
 252   1      
 253   1      
 254   1      
 255   1      
 256   1      
 257   1      
 258   1      
 259   1      
 260   1      }
 261          
 262          
 263          /*----------------------------------------------------------*/
 264          
 265          
 266          uint16_t Get_SysTick(void)
 267          {
 268   1              uint16_t uiTick;
 269   1              
 270   1              DISABLE_INTERRUPTS();
 271   1              uiTick = uiSysTick;
 272   1              ENABLE_INTERRUPTS();
 273   1              
 274   1              return uiTick;
 275   1      }
 276          
 277          uint16_t Get_ElapseTick(uint16_t uiPreTick)
 278          {
 279   1              uint16_t uiTick = Get_SysTick();
 280   1      
 281   1              if ( uiTick >= uiPreTick )      
 282   1                      return (uiTick - uiPreTick); 
 283   1              else 
 284   1                      return (0xFFFF - uiPreTick + uiTick);
 285   1      }
 286          
 287          const int32_t NTC_B3450[29][2] = 
 288          {
 289                  251783, -400,   184546, -350,   137003, -300,   102936, -250,   78219,  -200,
 290                  60072,  -150,   46601,  -100,   36495,  -50,    28837,  0,              22980,  50,
 291                  18460,  100,    14942,  150,    12182,  200,    10000,  250,    8263,   300,
 292                  6869,   350,    5745,   400,    4832,   450,    4085,   500,    3472,   550,
 293                  2965,   600,    2544,   650,    2193,   700,    1898,   750,    1649,   800,
 294                  1439,   850,    1260,   900,    1108,   950,    977,    1000
 295          };
 296          
 297          int32_t NTCtoTemp(int32_t ntc)
 298          {
 299   1              uint8_t i,j;
 300   1      
 301   1              if ( ntc > NTC_B3450[0][0] ){
 302   2                      return NTC_B3450[0][1];
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 6   

 303   2              } else {
 304   2                      for(i=0;i<sizeof(NTC_B3450)/sizeof(NTC_B3450[0][0])/2-1;i++){
 305   3                              if ( ntc <= NTC_B3450[i][0] && ntc > NTC_B3450[i+1][0] )
 306   3                                      break;
 307   3                      }
 308   2                      if ( i == sizeof(NTC_B3450)/sizeof(NTC_B3450[0][0])/2-1 ){
 309   3                              return NTC_B3450[28][1];
 310   3                      } else {
 311   3                              for(j=0;j<50;j++){
 312   4                                      if ( NTC_B3450[i][0] - (j*(NTC_B3450[i][0] - NTC_B3450[i+1][0])/50) <= ntc )
 313   4                                              return NTC_B3450[i][1] + j;
 314   4                              }
 315   3                              return NTC_B3450[i+1][1];
 316   3                      }
 317   2              }
 318   1      }
 319          
 320          void HotReset(void)
 321          {
 322   1              if (sConfig.ucBike[0] == 'b' &&
 323   1              //      sConfig.ucBike[1] == 'i' && 
 324   1              //      sConfig.ucBike[2] == 'k' && 
 325   1                      sConfig.ucBike[3] == 'e' ){
 326   2                      sBike.bHotReset = 1;
 327   2              } else {
 328   2                      sBike.bHotReset = 0;
 329   2              }
 330   1      }
 331          
 332          void WriteConfig(void)
 333          {
 334   1              uint8_t *cbuf = (uint8_t *)&sConfig;
 335   1              uint8_t i;
 336   1      
 337   1              sConfig.ucBike[0] = 'b';
 338   1              sConfig.ucBike[1] = 'i';
 339   1              sConfig.ucBike[2] = 'k';
 340   1              sConfig.ucBike[3] = 'e';
 341   1              sConfig.uiVersion = SW_VER;
 342   1              for(sConfig.ucSum=0,i=0;i<sizeof(BIKE_CONFIG)-1;i++)
 343   1                      sConfig.ucSum += cbuf[i];
 344   1                      
 345   1              FlashWrite(cbuf,sizeof(BIKE_CONFIG));
 346   1      }
 347          void ResetConfig(void)
 348          {
 349   1              sConfig.uiSysVoltage    = 60;
 350   1              sConfig.uiVolScale      = 1000;
 351   1              sConfig.uiTempScale     = 1000;
 352   1              sConfig.uiSpeedScale    = 1000;
 353   1              sConfig.uiYXT_SpeedScale= 1000;
 354   1      #ifdef SINGLE_TRIP
                      sConfig.uiSingleTrip    = 1;
              #else
 357   1              sConfig.uiSingleTrip    = 0;
 358   1      #endif
 359   1              sConfig.ulMile                  = 0;
 360   1              WriteConfig();
 361   1      }
 362          
 363          void InitConfig(void)
 364          {
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 7   

 365   1              uint8_t *cbuf = (uint8_t *)&sConfig;
 366   1              uint8_t i,sum;
 367   1      
 368   1              FlashRead(cbuf,sizeof(BIKE_CONFIG));
 369   1      
 370   1              for(sum=0,i=0;i<sizeof(BIKE_CONFIG)-1;i++)
 371   1                      sum += cbuf[i];
 372   1                      
 373   1              if (sConfig.ucBike[0] != 'b' || 
 374   1                      sConfig.ucBike[1] != 'i' || 
 375   1                      sConfig.ucBike[2] != 'k' || 
 376   1                      sConfig.ucBike[3] != 'e' || 
 377   1                      //sConfig.uiVersion     != SW_VER || 
 378   1                      sum != sConfig.ucSum ){
 379   2                      ResetConfig();
 380   2              }
 381   1      
 382   1              sBike.ulMile = sConfig.ulMile;
 383   1      #if ( TIME_ENABLE == 1 )
                      sBike.bHasTimer = 0;
              #endif
 386   1              sBike.ulFMile = 0;
 387   1              sBike.ucSpeedMode = 0;
 388   1              sBike.bYXTERR = 1;
 389   1      }
 390          
 391          uint8_t GetBatStatus(uint16_t uiVol)
 392          {
 393   1              uint8_t i;
 394   1              const uint16_t *uiBatStatus;
 395   1      
 396   1              switch ( sConfig.uiSysVoltage ){
 397   2              case 48:uiBatStatus = uiBatStatus48;break;
 398   2              case 60:uiBatStatus = uiBatStatus60;break;
 399   2              case 72:uiBatStatus = uiBatStatus72;break;
 400   2              default:uiBatStatus = uiBatStatus60;break;
 401   2              }
 402   1      
 403   1              for(i=0;i<ContainOf(uiBatStatus60);i++)
 404   1                      if ( uiVol < uiBatStatus[i] ) break;
 405   1              return i;
 406   1      }
 407          
 408          #if 0
              #ifdef LCD8794GCT
              
              const uint16_t BatEnergy48[8] = {420,490};
              const uint16_t BatEnergy60[8] = {520,620};
              const uint16_t BatEnergy72[8] = {630,740};
              
              uint8_t GetBatEnergy(uint16_t uiVol)
              {
                      uint16_t uiEnergy ;
                      const uint16_t* BatEnergy;
                      
                      switch ( sConfig.uiSysVoltage ){
                      case 48:BatEnergy = BatEnergy48;break;
                      case 60:BatEnergy = BatEnergy60;break;
                      case 72:BatEnergy = BatEnergy72;break;
                      default:BatEnergy = BatEnergy60;break;
                      }
              
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 8   

                      if ( sBike.uiVoltage <= BatEnergy[0] ) uiEnergy = 0;
                      else if ( sBike.uiVoltage >= BatEnergy[1] ) uiEnergy = 100;
                      else {
                              uiEnergy = (sBike.uiVoltage - BatEnergy[0])*100/(BatEnergy[1] - BatEnergy[0]);
                      }
                      return uiEnergy;
              }
              #endif
              #endif
 436          
 437          
 438          
 439          void LRFlashTask(void)
 440          {
 441   1              static uint8_t ucLeftOn=0       ,ucLeftOff=0;   //开启计时器
 442   1              static uint8_t ucRightOn=0      ,ucRightOff=0;  //关闭计时器
 443   1              static uint8_t ucLeftCount=0,ucRightCount=0;//开启时间计时器
 444   1      
 445   1              if ( READ_TURN_LEFT() ){        //ON
 446   2              ucLeftOff = 0;
 447   2              if ( ucLeftOn ++ > 10 ){                //200ms 滤波
 448   3                  if ( ucLeftOn > 100 ){
 449   4                          ucLeftOn = 101;
 450   4                      sBike.bLFlashType = 0;  //长时间开启，为开关信号
 451   4                  }
 452   3                      if ( ucLeftCount < 0xFF-50 ){
 453   4                          ucLeftCount++;
 454   4                  }
 455   3                              sBike.bLeftFlash= 1;            //闪光信号
 456   3                              sBike.bTurnLeft = 1;            //转向信号
 457   3              }
 458   2              } else {                                        //OFF
 459   2              ucLeftOn = 0;
 460   2              if ( ucLeftOff ++ == 10 ){
 461   3                      ucLeftCount += 25;                      //在开启时间上加500ms
 462   3                              sBike.bLeftFlash = 0;
 463   3              } else if ( ucLeftOff > 10 ){
 464   3                      ucLeftOff = 11;
 465   3                  sBike.bLFlashType = 1;              //闪光器信号
 466   3                  if ( ucLeftCount == 0 ){
 467   4                                      sBike.bTurnLeft = 0;
 468   4                  } else
 469   3                                      ucLeftCount --;
 470   3                      }
 471   2              }
 472   1              
 473   1              if ( READ_TURN_RIGHT() ){       //ON
 474   2              ucRightOff = 0;
 475   2              if ( ucRightOn ++ > 10 ){
 476   3                  if ( ucRightOn > 100 ){
 477   4                          ucRightOn = 101;
 478   4                      sBike.bRFlashType = 0;
 479   4                  }
 480   3                      if ( ucRightCount < 0xFF-50 ){
 481   4                                      ucRightCount++;
 482   4                  }
 483   3                              sBike.bRightFlash= 1;
 484   3                              sBike.bTurnRight = 1;
 485   3              }
 486   2              } else {                                        //OFF
 487   2              ucRightOn = 0;
 488   2              if ( ucRightOff ++ == 10 ){
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 9   

 489   3                      ucRightCount += 25;     //500ms
 490   3                              sBike.bRightFlash = 0;
 491   3              } else if ( ucRightOff > 10 ){
 492   3                      ucRightOff = 11;
 493   3                  sBike.bRFlashType = 1;
 494   3                  if ( ucRightCount == 0 ){
 495   4                                      sBike.bTurnRight = 0;
 496   4                  } else
 497   3                                      ucRightCount --;
 498   3                      }
 499   2              }
 500   1      }
 501          
 502          uint8_t MileSetupTask(void)
 503          {
 504   1              static uint16_t uiPreTick=0;
 505   1              static uint8_t TaskFlag = TASK_INIT;
 506   1              static uint8_t ucCount = 0;
 507   1              uint8_t ret = 0;
 508   1      
 509   1              switch( TaskFlag ){
 510   2              case TASK_INIT:
 511   2                      if ( Get_SysTick() < 3000 && sBike.bTurnRight == 1 ){
 512   3                              TaskFlag = TASK_STEP1;
 513   3                              ucCount = 0;
 514   3                      }
 515   2                      break;
 516   2              case TASK_STEP1:
 517   2                      if ( sBike.bLastNear == 0 && sBike.bNearLight ){
 518   3                              uiPreTick = Get_SysTick();
 519   3                              if ( ++ucCount >= 8 ){
 520   4                                      TaskFlag = TASK_STEP2;
 521   4                                      ucCount = 0;
 522   4                                      sBike.bMileFlash = 1;
 523   4                                      sBike.ulMile = sConfig.ulMile;
 524   4                              } 
 525   3                      }
 526   2                      sBike.bLastNear = sBike.bNearLight;
 527   2                      ret = 1;
 528   2                      break;
 529   2              case TASK_STEP2:
 530   2                      if ( sBike.bTurnRight == 0 && sBike.bTurnLeft == 1 ) {
 531   3                              ucCount = 0;
 532   3                              TaskFlag = TASK_EXIT;
 533   3                              sBike.ulFMile   = 0;
 534   3                              sBike.ulMile    = 0;
 535   3                              sConfig.ulMile  = 0;
 536   3                              WriteConfig();
 537   3                      } else if ( sBike.bTurnRight == 0 && sBike.bTurnLeft == 0 ) {
 538   3                              if ( sBike.bLastNear == 0 && sBike.bNearLight){
 539   4                                      uiPreTick = Get_SysTick();
 540   4                                      if ( ++ucCount >= 4 ){
 541   5                                              TaskFlag = TASK_STEP3;
 542   5                                              if ( sConfig.uiSingleTrip ){
 543   6                                                      sConfig.uiSingleTrip = 0;
 544   6                                                      sBike.ulMile = 22222UL;
 545   6                                              } else {
 546   6                                                      sConfig.uiSingleTrip = 1;
 547   6                                                      sBike.ulMile = 11111UL;
 548   6                                              }
 549   5                                              WriteConfig();
 550   5                                      }
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 10  

 551   4                              }
 552   3                      }
 553   2                      sBike.bLastNear = sBike.bNearLight;
 554   2                      ret = 1;
 555   2                      break;
 556   2              case TASK_STEP3:
 557   2                      if ( Get_ElapseTick(uiPreTick) > 3000 ) {
 558   3                              TaskFlag = TASK_EXIT;
 559   3                              if ( sConfig.uiSingleTrip )
 560   3                                      sBike.ulMile = 0;
 561   3                              else
 562   3                                      sBike.ulMile = sConfig.ulMile;
 563   3                      }
 564   2                      ret = 1;
 565   2                      break;
 566   2              case TASK_EXIT:
 567   2              default:
 568   2                              sBike.bMileFlash = 0;
 569   2                      break;
 570   2              }
 571   1      
 572   1              if ( Get_ElapseTick(uiPreTick) > 10000/* || sBike.bBraked || sBike.ucSpeed*/ )
 573   1                      TaskFlag = TASK_EXIT;
 574   1              
 575   1              return ret;
 576   1      }
 577          
 578          void MileTask(void)
 579          {
 580   1      #define MT_INIT                                 0
 581   1      #define MT_SHOW_TOTAL_MILE_2S   1
 582   1      #define MT_WAIT_SPEED                   2
 583   1      #define MT_SHOW_MILE                    3
 584   1      
 585   1              static uint16_t uiTime = 0;
 586   1              static uint8_t task=MT_INIT;
 587   1              
 588   1              if ( MileSetupTask() ){
 589   2                      task    = MT_INIT;
 590   2                      return ;
 591   2              }
 592   1      
 593   1              uiTime ++;
 594   1              switch( task ){
 595   2              case MT_INIT:
 596   2                      if ( sConfig.uiSingleTrip == 0 )
 597   2                              task = MT_SHOW_MILE;
 598   2                      else
 599   2                              task = MT_SHOW_TOTAL_MILE_2S;
 600   2                      sBike.ulMile  = sConfig.ulMile;
 601   2                      sBike.ulFMile = 0;
 602   2                      uiTime  = 0;
 603   2                      break;
 604   2              case MT_SHOW_TOTAL_MILE_2S:
 605   2                      if ( uiTime > 20 )      //2s
 606   2                              task = MT_WAIT_SPEED;
 607   2                      break;
 608   2              case MT_WAIT_SPEED:
 609   2                      if ( uiTime > 50 || sBike.ucSpeed > 0 ){
 610   3                              task = MT_SHOW_MILE;
 611   3                              sBike.ulMile = 0;
 612   3                      }
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 11  

 613   2                      break;  
 614   2              case MT_SHOW_MILE:
 615   2                      if ( sBike.ucSpeed > DISPLAY_MAX_SPEED )
 616   2                              sBike.ulFMile += DISPLAY_MAX_SPEED;
 617   2                      else
 618   2                              sBike.ulFMile += sBike.ucSpeed;
 619   2                      
 620   2                      if(sBike.ulFMile >= 36000)
 621   2                      {
 622   3                              sBike.ulFMile = 0;
 623   3                              sBike.ulMile++;
 624   3                              if ( sBike.ulMile > 99999 )             sBike.ulMile = 0;
 625   3                              sConfig.ulMile ++;
 626   3                              if ( sConfig.ulMile > 99999 )   sConfig.ulMile = 0;
 627   3                              WriteConfig();
 628   3                      }  
 629   2                      break;
 630   2              default:
 631   2                      task = MT_INIT;
 632   2                      break;
 633   2              }
 634   1      #undef MT_INIT
 635   1      #undef MT_SHOW_TOTAL_MILE_2S
 636   1      #undef MT_WAIT_SPEED
 637   1      #undef MT_SHOW_MILE     
 638   1      }
 639          
 640          uint8_t SpeedCaltTask(void)
 641          {
 642   1              static uint16_t uiPreTick=0;
 643   1              static uint8_t TaskFlag = TASK_INIT;
 644   1              static uint8_t ucLastSpeed = 0;
 645   1              static uint8_t ucCount = 0;
 646   1          static signed char scSpeedInc=0;
 647   1              static uint8_t yxterr=0;
 648   1              signed char scSpeed;
 649   1              
 650   1              switch( TaskFlag ){
 651   2              case TASK_INIT:
 652   2                      if ( Get_SysTick() < 3000 && sBike.bTurnLeft == 1 ){
 653   3                              TaskFlag = TASK_STEP1;
 654   3                              ucCount = 0;
 655   3                      }
 656   2                      break;
 657   2              case TASK_STEP1:
 658   2                      if ( sBike.bLastNear == 0 && sBike.bNearLight){
 659   3                              if ( ++ucCount >= 8 ){
 660   4                                      TaskFlag = TASK_STEP2;
 661   4                                      ucCount         = 0;
 662   4                                      scSpeedInc      = 0;
 663   4                                      sBike.bSpeedFlash = 1;
 664   4                                      yxterr = sBike.bYXTERR;
 665   4                                      if ( yxterr )
 666   4                                              sConfig.uiSpeedScale     = 1000;
 667   4                                      else
 668   4                                              sConfig.uiYXT_SpeedScale = 1000;
 669   4                              }
 670   3                              uiPreTick = Get_SysTick();
 671   3                      }
 672   2                      sBike.bLastNear  = sBike.bNearLight;
 673   2                      break;
 674   2              case TASK_STEP2:
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 12  

 675   2                      if ( sBike.bLastNear == 0 && sBike.bNearLight == 1 ){
 676   3                              uiPreTick = Get_SysTick();
 677   3                  if ( sBike.bTurnLeft == 1 ) {
 678   4                                      ucCount = 0;
 679   4                                      if ( sBike.ucSpeed + scSpeedInc > 1 )
 680   4                                              scSpeedInc --;
 681   4                      } else if ( sBike.bTurnRight == 1 ) {
 682   4                                      ucCount = 0;
 683   4                      if ( sBike.ucSpeed + scSpeedInc < 99 )
 684   4                                              scSpeedInc ++;
 685   4                  } else {
 686   4                                      if ( ++ucCount >= 4 ){
 687   5                                              TaskFlag = TASK_EXIT;
 688   5                                              sBike.bSpeedFlash = 0;
 689   5                                              if ( sBike.ucSpeed ) {
 690   6                                                      if ( yxterr )
 691   6                                                              sConfig.uiSpeedScale     = (uint32_t)sBike.ucSpeed*1000UL/(sBike.ucSpeed+scSpeedInc);
 692   6                                                      else
 693   6                                                              sConfig.uiYXT_SpeedScale = (uint32_t)sBike.ucSpeed*1000UL/(sBike.ucSpeed+scSpeedInc);
 694   6                                                      WriteConfig();
 695   6                                              }
 696   5                                      }
 697   4                              }
 698   3                      }
 699   2                      sBike.bLastNear = sBike.bNearLight;
 700   2              
 701   2                      if ( sBike.ucSpeed )
 702   2                              uiPreTick = Get_SysTick();
 703   2      
 704   2                      scSpeed = sBike.ucSpeed + scSpeedInc;
 705   2                      if ( scSpeed < 0 )
 706   2                              sBike.ucSpeed = 0;
 707   2                      else
 708   2                              sBike.ucSpeed = scSpeed;
 709   2                              
 710   2                      if ( ucLastSpeed && sBike.ucSpeed == 0 )
 711   2                              TaskFlag = TASK_EXIT;
 712   2                              
 713   2                      ucLastSpeed = sBike.ucSpeed;
 714   2                      break;
 715   2              case TASK_EXIT:
 716   2              default:
 717   2                      sBike.bSpeedFlash = 0;
 718   2                      break;
 719   2              }
 720   1              if ( Get_ElapseTick(uiPreTick) > 10000 || sBike.bBraked )
 721   1                      TaskFlag = TASK_EXIT;
 722   1      
 723   1              return 0;
 724   1      }
 725          
 726          #if ( TIME_ENABLE == 1 )
              void TimeTask(void)
              {
                      static uint8_t ucTask=0,ucLeftOn= 0,NL_on = 0;
                      static uint16_t uiPreTick;
                      
                      if (!sBike.bHasTimer)
                              return ;
                      
                      if (sBike.ucSpeed > 1)
                              ucTask = 0xff;
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 13  

                      
                      switch ( ucTask ){
                      case 0:
                              if ( Get_SysTick() < 5000 && sBike.bNearLight == 0 && sBike.bTurnLeft == 1 ){
                                      uiPreTick = Get_SysTick();
                                      ucTask++;
                              }
                              break;
                      case 1:
                              if ( sBike.bTurnLeft == 0 ){
                                      if ( Get_ElapseTick(uiPreTick) < 2000  ) ucTask = 0xFF; else { uiPreTick = Get_SysTick(); ucTask++; }
                              } else {
                                      if ( Get_ElapseTick(uiPreTick) > 10000 || sBike.bNearLight ) ucTask = 0xFF;
                              }
                              break;
                      case 2:
                              if ( sBike.bTurnRight == 1 ){
                                      if ( Get_ElapseTick(uiPreTick) > 1000  ) ucTask = 0xFF; else { uiPreTick = Get_SysTick(); ucTask++; }
                              } else {
                                      if ( Get_ElapseTick(uiPreTick) > 1000  || sBike.bNearLight ) ucTask = 0xFF;
                              }
                              break;
                      case 3:
                              if ( sBike.bTurnRight == 0 ){
                                      if ( Get_ElapseTick(uiPreTick) < 2000  ) ucTask = 0xFF; else { uiPreTick = Get_SysTick(); ucTask++; }
                              } else {
                                      if ( Get_ElapseTick(uiPreTick) > 10000 || sBike.bNearLight ) ucTask = 0xFF;
                              }
                              break;
                      case 4:
                              if ( sBike.bTurnLeft == 1 ){
                                      if ( Get_ElapseTick(uiPreTick) > 1000  ) ucTask = 0xFF; else { uiPreTick = Get_SysTick(); ucTask++; }
                              } else {
                                      if ( Get_ElapseTick(uiPreTick) > 1000  || sBike.bNearLight ) ucTask = 0xFF;
                              }
                              break;
                      case 5:
                              if ( sBike.bTurnLeft == 0 ){
                                      if ( Get_ElapseTick(uiPreTick) < 2000  ) ucTask = 0xFF; else { uiPreTick = Get_SysTick(); ucTask++; }
                              } else {
                                      if ( Get_ElapseTick(uiPreTick) > 10000 || sBike.bNearLight ) ucTask = 0xFF;
                              }
                              break;
                      case 6:
                              if ( sBike.bTurnRight == 1 ){
                                      if ( Get_ElapseTick(uiPreTick) > 1000  ) ucTask = 0xFF; else { uiPreTick = Get_SysTick(); ucTask++; }
                              } else {
                                      if ( Get_ElapseTick(uiPreTick) > 1000  || sBike.bNearLight ) ucTask = 0xFF;
                              }
                      case 7:
                              if ( sBike.bTurnRight == 0 ){
                                      if ( Get_ElapseTick(uiPreTick) < 2000  ) ucTask = 0xFF; else { uiPreTick = Get_SysTick(); ucTask++; }
                              } else {
                                      if ( Get_ElapseTick(uiPreTick) > 10000 || sBike.bNearLight ) ucTask = 0xFF;
                              }
                              break;
                      case 8:
                              if ( sBike.bTurnLeft == 1 ){
                                      if ( Get_ElapseTick(uiPreTick) > 1000  ) ucTask = 0xFF; else { uiPreTick = Get_SysTick(); ucTask++; }
                              } else {
                                      if ( Get_ElapseTick(uiPreTick) > 1000  || sBike.bNearLight ) ucTask = 0xFF;
                              }
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 14  

                      case 9:
                              if ( sBike.bTurnLeft == 0 ){
                                      if ( Get_ElapseTick(uiPreTick) < 2000  ) ucTask = 0xFF; else { uiPreTick = Get_SysTick(); ucTask++; }
                              } else {
                                      if ( Get_ElapseTick(uiPreTick) > 10000 || sBike.bNearLight ) ucTask = 0xFF;
                              }
                              break;
                      case 10:
                              if ( sBike.bTurnRight == 1 ){
                                      if ( Get_ElapseTick(uiPreTick) > 1000  ) ucTask = 0xFF; else { uiPreTick = Get_SysTick(); ucTask++; }
                              } else {
                                      if ( Get_ElapseTick(uiPreTick) > 1000  || sBike.bNearLight ) ucTask = 0xFF;
                              }
                      case 11:
                              if ( sBike.bTurnRight == 0 ){
                                      if ( Get_ElapseTick(uiPreTick) < 2000  ) ucTask = 0xFF; else { uiPreTick = Get_SysTick(); ucTask++; }
                              } else {
                                      if ( Get_ElapseTick(uiPreTick) > 10000 || sBike.bNearLight ) ucTask = 0xFF;
                              }
                              break;
                      case 12:
                              if ( sBike.bTurnLeft == 1 || sBike.bNearLight ){
                                       ucTask = 0xFF;
                              } else {
                                      if ( Get_ElapseTick(uiPreTick) > 1000 ) {
                                              ucTask= 0;
                                              sBike.ucTimePos = 0;
                                              sBike.bTimeSet = 1; 
                                              uiPreTick = Get_SysTick();
                                      }
                              }
                              break;
                      default:
                              sBike.ucTimePos = 0;
                              sBike.bTimeSet = 0; 
                              ucTask = 0;
                              break;
                      }
              
                      if ( sBike.bTimeSet ){
                              if ( sBike.bTurnLeft ) { ucLeftOn = 1; }
                              if ( sBike.bTurnLeft == 0 ) {
                                      if ( ucLeftOn == 1 ){
                                              sBike.ucTimePos ++;
                                              sBike.ucTimePos %= 4;
                                              ucLeftOn = 0;
                                              uiPreTick = Get_SysTick();
                                      }
                              }
                              if ( sBike.bNearLight ) { NL_on = 1; uiPreTick = Get_SysTick(); }
                              if ( sBike.bNearLight == 0 && NL_on == 1 ) {
                                      NL_on = 0;
                                      if ( Get_ElapseTick(uiPreTick) < 5000 ){
                                              switch ( sBike.ucTimePos ){
                                              case 0:
                                                      sBike.ucHour += 10;
                                                      sBike.ucHour %= 20;
                                                      break;
                                              case 1:
                                                      if ( sBike.ucHour % 10 < 9 )
                                                              sBike.ucHour ++;
                                                      else 
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 15  

                                                              sBike.ucHour -= 9;
                                                      break;
                                              case 2:
                                                      sBike.ucMinute += 10;
                                                      sBike.ucMinute %= 60;
                                                      break;
                                              case 3:
                                                      if ( sBike.ucMinute % 10 < 9 )
                                                              sBike.ucMinute ++;
                                                      else 
                                                              sBike.ucMinute -= 9;
                                                      break;
                                              default:
                                                      sBike.bTimeSet = 0;
                                                      break;
                                              }
                                      }
                                      RtcTime.RTC_Hours       = sBike.ucHour;
                                      RtcTime.RTC_Minutes = sBike.ucMinute;
                                      PCF8563_SetTime(PCF_Format_BIN,&RtcTime);
                              }
                              if ( Get_ElapseTick(uiPreTick) > 30000 ){
                                      sBike.bTimeSet = 0;
                              }
                      }               
                      
                       PCF8563_GetTime(PCF_Format_BIN,&RtcTime);
                       sBike.ucHour           = RtcTime.RTC_Hours%12;
                       sBike.ucMinute         = RtcTime.RTC_Minutes;
              }
              #endif 
 892          /*----------------------------------------------------------*/
 893          
 894          
 895          void Light_Task(void)
 896          {
 897   1              uint8_t ucSpeedMode;
 898   1      
 899   1              if( GPIO_Read(NearLight_PORT,   NearLight_PIN) ) sBike.bNearLight = 1; else sBike.bNearLight = 0;
 900   1              //if( GPIO_Read(TurnRight_PORT, TurnRight_PIN) ) sBike.bTurnRight = 1; else sBike.bTurnRight = 0;
 901   1              //if( GPIO_Read(TurnLeft_PORT,  TurnLeft_PIN ) ) sBike.bTurnLeft  = 1; else sBike.bTurnLeft  = 0;
 902   1              //if( GPIO_Read(Braked_PORT,    Braked_PIN       ) ) sBike.bBraked    = 1; else sBike.bBraked    = 0;
 903   1              
 904   1              if ( sBike.bYXTERR ){
 905   2                      ucSpeedMode = 0;
 906   2                      if( GPIO_Read(SPMODE1_PORT,SPMODE1_PIN) ) ucSpeedMode |= 1<<0;
 907   2                      if( GPIO_Read(SPMODE2_PORT,SPMODE2_PIN) ) ucSpeedMode |= 1<<1;
 908   2                      if( GPIO_Read(SPMODE3_PORT,SPMODE3_PIN) ) ucSpeedMode |= 1<<2;
 909   2              #ifdef SPMODE4_PORT
 910   2                      if( GPIO_Read(SPMODE4_PORT,SPMODE4_PIN) ) ucSpeedMode |= 1<<3;
 911   2              #endif
 912   2                      switch(ucSpeedMode){
 913   3                              case 0x01:      sBike.ucSpeedMode = 1; break;
 914   3                              case 0x02:      sBike.ucSpeedMode = 2; break;
 915   3                              case 0x04:      sBike.ucSpeedMode = 3; break;
 916   3                              case 0x08:      sBike.ucSpeedMode = 4; break;
 917   3                              default:        sBike.ucSpeedMode = 0; break;
 918   3                      }
 919   2                      sBike.ucPHA_Speed= GetSpeed();
 920   2                      sBike.ucSpeed    = (uint32_t)sBike.ucPHA_Speed*1000UL/sConfig.uiSpeedScale;
 921   2              }
 922   1      }
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 16  

 923          
 924          #if 0
              void main(void)
              {
                      uint8_t i;
                      uint16_t uiTick;
                      uint16_t uiCount=0;
                      uint16_t uiVol=0;
                      uint16_t tick_100ms=0;
                      
                      /* select Clock = 8 MHz */
                      CLK_SYSCLKConfig(CLK_PRESCALER_HSIDIV2);
                      CLK_HSICmd(ENABLE);
                      IWDG_Config();
              
              #ifdef RESET_CONFIG
                      ResetConfig();
                      BL55072_Config(2);
                      MenuUpdate(&sBike);
                      while(1){ FEED_DOG(); }
              #else
                      Init_timer();  
                      HotReset();
                      if ( sBike.bHotReset == 0 ) {
                              BL55072_Config(1);
                      } else
                              BL55072_Config(0);
              
              //      for(i=0;i<32;i++){      GetVol();       /*FEED_DOG(); */ }
              //      for(i=0;i<16;i++){      GetSpeed();     /*FEED_DOG(); */ }
                      for(i=0;i<4;i++) {      GetTemp();      FEED_DOG(); }
              
                      InitConfig();
                      Calibration();
                      
              #if ( TIME_ENABLE == 1 )        
                      //sBike.bHasTimer = !PCF8563_Check();
                      sBike.bHasTimer = PCF8563_GetTime(PCF_Format_BIN,&RtcTime);
                      #ifndef DENGGUAN_XUNYING_T
                      InitUART();
                      #endif
              #endif
              
              #if ( YXT_ENABLE == 1 )
                      YXT_Init();  
              #endif
                
                      enableInterrupts();
                      
                      if ( sBike.bHotReset == 0 ) {
                              while ( Get_SysTick() < PON_ALLON_TIME ) FEED_DOG();
                              BL55072_Config(0);
                      }
                      
                      GetVolStabed(&uiVol);
                      sBike.uiVoltage = (uint32_t)uiVol*1000UL/sConfig.uiVolScale;
                      sBike.siTemperature = GetTemp();
                      
                      while(1){
                              uiTick = Get_SysTick();
                              
                              if ( (uiTick >= tick_100ms && (uiTick - tick_100ms) >= 100 ) || \
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 17  

                                       (uiTick <  tick_100ms && (0xFFFF - tick_100ms + uiTick) >= 100 ) ) {
                                      tick_100ms = uiTick;
                                      uiCount ++;
                                      
                                      if ( (uiCount % 5) == 0 ) {
                                              if ( GetVolStabed(&uiVol) ){
                                                      sBike.uiVoltage = (uint32_t)uiVol*1000UL/sConfig.uiVolScale;
                                                      sBike.ucBatStatus= GetBatStatus(sBike.uiVoltage);
                                              }
                                      }
                                      if ( (uiCount % 10) == 0 ){
                                              //      sBike.siTemperature= (long)GetTemp()    *1000UL/sConfig.TempScale;
                                                      sBike.siTemperature= GetTemp();
                                              }
                              #ifdef LCD8794GCT
                                      //sBike.ucEnergy        = GetBatEnergy(sBike.uiVoltage);
                              #endif
                              
                                      Light_Task();
                                      MileTask(); 
                                      
                              #if ( YXT_ENABLE == 1 )
                                      YXT_Task(&sBike,&sConfig);  
                              #endif
                                      
                                      SpeedCaltTask();
                              
                              #if ( TIME_ENABLE == 1 )        
                                      TimeTask();   
                              #endif
                    
                              #ifdef LCD_SEG_TEST
                                      if ( ++uiCount >= 100 ) uiCount = 0;
                                      sBike.uiVoltage         = uiCount/10 + uiCount/10*10UL + uiCount/10*100UL + uiCount/10*1000UL;
                                      sBike.siTemperature     = uiCount/10 + uiCount/10*10UL + uiCount/10*100UL;
                                      sBike.ucSpeed           = uiCount/10 + uiCount/10*10;
                                      sBike.ulMile            = uiCount/10 + uiCount/10*10UL + uiCount/10*100UL + uiCount/10*1000UL + uiCount/10*10000U
             -L;
                                      sBike.ucHour            = uiCount/10 + uiCount/10*10;
                                      sBike.ucMinute          = uiCount/10 + uiCount/10*10;
                                      #ifdef LCD8794GCT
                                      //sBike.ucEnergy    = uiCount/10 + uiCount/10*10UL;
                                      #endif
                              #endif
                      
                                      MenuUpdate(&sBike);
                                      
                                      /* Reload IWDG counter */
                                      FEED_DOG();  
                              } 
              
                      #if ( TIME_ENABLE == 1 )
                              #ifndef DENGGUAN_XUNYING_T
                              UartTask();
                              #endif
                      #endif
                      }
              #endif  
              }
              #endif
1044          
1045          /************************ (C) COPYRIGHT  *****END OF FILE****/
C51 COMPILER V9.50a   BIKE                                                                 12/04/2017 14:02:10 PAGE 18  



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3712    ----
   CONSTANT SIZE    =     48    ----
   XDATA SIZE       =    403      97
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
